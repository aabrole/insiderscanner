// This Pine Script™ indicator shows prediction market probabilities from Pine Seeds data
// in a TABLE on the chart (like a normal indicator) and optionally as plotted series.
// It uses request.seed() to read data from a Pine Seeds–compatible GitHub repo.
//
// === SETUP ===
// 1. Add the Pine Seeds symbol to your chart (Symbol Search → e.g. SEED_OWNER_REPO:PM_SPX_UP_TODAY_YES).
// 2. Apply this indicator → it shows a table with Probability, Smoothed, ROC, Regime.
// 3. In inputs: set Pine Seed source and symbol to match your repo/CSV name.
//
// @version=6
indicator("Prediction Markets (Pine Seeds)", overlay = false, max_bars_back = 500, max_lines_count = 500, max_labels_count = 500)

// --- Inputs ---
string seedSourceInput = input.string("seed_owner_repo", "Pine Seed source (repo id)", group = "Seed")
string seedSymbolInput  = input.string("PM_SPX_UP_TODAY_YES", "Pine Seed symbol (CSV name)", group = "Seed")
bool   showTable       = input.bool(true, "Show table on chart", group = "Display")
bool   showPlots       = input.bool(true, "Show plotted series (lines)", group = "Display")
string tablePosition   = input.string("Top Right", "Table position", options = ["Top Right", "Top Left", "Middle Right", "Middle Left"], group = "Display")
int    emaLength       = input.int(5, "EMA length (smoothing)", minval = 1, group = "Display")
float  bearThreshold   = input.float(40.0, "Bear regime (<)", minval = 0, maxval = 100, group = "Regime")
float  bullThreshold   = input.float(60.0, "Bull regime (>)", minval = 0, maxval = 100, group = "Regime")
float  rocSpikePct     = input.float(5.0, "ROC spike alert (%)", minval = 0.1, group = "Alerts")

// --- Table position (v6: no type keyword) ---
pos = tablePosition == "Top Left" ? position.top_left : tablePosition == "Middle Right" ? position.middle_right : tablePosition == "Middle Left" ? position.middle_left : position.top_right

// --- Load seed data (close = probability 0–100). v6: no type keyword, infer from request.seed() ---
prob = request.seed(seedSourceInput, seedSymbolInput, "close")
smooth = ta.ema(prob, emaLength)
roc = prob[1] != 0 ? (prob - prob[1]) / prob[1] * 100.0 : 0.0
isBear = prob < bearThreshold
isBull = prob > bullThreshold
isNeutral = not isBear and not isBull

// --- Regime label ---
regimeStr = isBear ? "Bear" : isBull ? "Bull" : "Neutral"

// --- Table: display all prediction data on the chart ---
var infoTable = table.new(pos, 2, 12, bgcolor = color.new(#131722, 10), border_width = 1, border_color = color.new(#787b86, 50))

if barstate.islast and showTable
    row = 0
    table.cell(infoTable, 0, row, "Prediction Markets", text_color = color.white, text_size = size.normal)
    table.cell(infoTable, 1, row, seedSymbolInput, text_color = color.gray, text_size = size.small)
    row += 1
    table.cell(infoTable, 0, row, "Probability", text_color = color.gray, text_size = size.small)
    table.cell(infoTable, 1, row, str.tostring(prob, "#.##") + " %", text_color = color.white, text_size = size.small)
    row += 1
    table.cell(infoTable, 0, row, "Smoothed (EMA)", text_color = color.gray, text_size = size.small)
    table.cell(infoTable, 1, row, str.tostring(smooth, "#.##") + " %", text_color = #00c853, text_size = size.small)
    row += 1
    table.cell(infoTable, 0, row, "ROC", text_color = color.gray, text_size = size.small)
    table.cell(infoTable, 1, row, str.tostring(roc, "#.##") + " %", text_color = roc >= 0 ? color.new(#00c853, 0) : color.new(#ff5252, 0), text_size = size.small)
    row += 1
    table.cell(infoTable, 0, row, "Regime", text_color = color.gray, text_size = size.small)
    regimeColor = isBear ? #ff5252 : isBull ? #69f0ae : #ffeb3b
    table.cell(infoTable, 1, row, regimeStr, text_color = regimeColor, text_size = size.small)
    row += 1
    table.cell(infoTable, 0, row, "", text_color = color.gray, text_size = size.tiny)
    table.cell(infoTable, 1, row, "", text_color = color.gray, text_size = size.tiny)
    row += 1
    table.cell(infoTable, 0, row, "Seed", text_color = color.gray, text_size = size.tiny)
    table.cell(infoTable, 1, row, seedSourceInput + ":" + seedSymbolInput, text_color = color.gray, text_size = size.tiny)

// --- Optional plots ---
plot(showPlots ? prob : na, "Probability", color = color.new(#2962ff, 0), linewidth = 2)
plot(showPlots ? smooth : na, "Smoothed (EMA)", color = color.new(#00c853, 0), linewidth = 1)
plot(showPlots ? roc : na, "ROC (%)", color = color.new(#ffab00, 0), linewidth = 1)
bgcolor(showPlots and (isBear or isBull or isNeutral) ? (isBear ? color.new(#ff5252, 85) : isBull ? color.new(#69f0ae, 85) : color.new(#ffeb3b, 92)) : na)
hline(showPlots ? 0 : na, "ROC zero", color = color.gray, linestyle = hline.style_dotted)

// --- Alerts ---
alertcondition(ta.crossover(prob, bearThreshold), "Cross above bear threshold", "Probability crossed above bear threshold")
alertcondition(ta.crossunder(prob, bearThreshold), "Cross below bear threshold", "Probability crossed below bear threshold")
alertcondition(ta.crossover(prob, bullThreshold), "Cross above bull threshold", "Probability crossed above bull threshold")
alertcondition(ta.crossunder(prob, bullThreshold), "Cross below bull threshold", "Probability crossed below bull threshold")
alertcondition(ta.cross(roc, rocSpikePct) or ta.cross(roc, -rocSpikePct), "ROC spike", "Prediction market ROC spike")
alertcondition(ta.crossover(prob, smooth), "Prob cross above EMA", "Probability crossed above smoothed")
alertcondition(ta.crossunder(prob, smooth), "Prob cross below EMA", "Probability crossed below smoothed")
