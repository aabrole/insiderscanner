// @version=6
indicator("Prediction Markets (Polymarket / Kalshi)", overlay = false, max_bars_back = 500)

// --- Inputs ---
string baseUrlInput = input.string(
     "https://insiderscanner.vercel.app",
     "Backend base URL",
     group = "API",
     tooltip = "e.g. https://insiderscanner.vercel.app (no trailing slash)"
 )
string symbolOverride = input.string(
     "",
     "Symbol override",
     group = "API",
     tooltip = "Leave empty to use chart symbol (e.g. SPY, SPX). Set to a key from config to show that market."
 )

// --- Symbol and URLs (Pine cannot fetch external URLs; open in browser for live data) ---
string symbol = str.length(symbolOverride) > 0 ? symbolOverride : syminfo.ticker
string baseUrl = str.length(baseUrlInput) > 0 ? baseUrlInput : ""
string apiUrl = str.length(baseUrl) > 0 ? baseUrl + "/api/prediction?symbol=" + symbol : ""
string statsUrl = str.length(baseUrl) > 0 ? baseUrl + "/predictions" : ""

// --- Table ---
var table infoTable = table.new(position.top_right, 2, 10, bgcolor = color.new(color.black, 85), border_width = 1)

if barstate.islast
    table.cell(infoTable, 0, 0, "Prediction Markets", text_color = color.white, text_size = size.small)
    table.cell(infoTable, 1, 0, symbol, text_color = color.gray, text_size = size.small)

    if str.length(baseUrl) == 0
        table.cell(infoTable, 0, 1, "Info", text_color = color.orange, text_size = size.tiny)
        table.cell(infoTable, 1, 1, "Set Backend base URL in settings", text_color = color.orange, text_size = size.tiny)
    else
        table.cell(infoTable, 0, 1, "SPX-style stats", text_color = color.aqua, text_size = size.tiny)
        table.cell(infoTable, 1, 1, "Open in browser:", text_color = color.gray, text_size = size.tiny)
        table.cell(infoTable, 0, 2, "", text_color = color.gray, text_size = size.tiny)
        table.cell(infoTable, 1, 2, statsUrl, text_color = color.white, text_size = size.tiny)
        table.cell(infoTable, 0, 3, "Single symbol API", text_color = color.gray, text_size = size.tiny)
        table.cell(infoTable, 1, 3, apiUrl, text_color = color.gray, text_size = size.tiny)
        table.cell(infoTable, 0, 4, "Note", text_color = color.gray, text_size = size.tiny)
        table.cell(infoTable, 1, 4, "Pine cannot fetch URLs. Open the links above for live Polymarket data.", text_color = color.gray, text_size = size.tiny)
